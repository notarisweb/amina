---
import Posts from "@/components/Posts.astro";
import Base from "@/layouts/Base.astro";
import { humanize } from "@/lib/utils/textConverter";

// 1. AKTIFKAN SSR: Wajib untuk mode server agar tidak 404
export const prerender = false;

// 2. Ambil parameter kategori dari URL
const { category } = Astro.params;
const WP_URL = import.meta.env.PUBLIC_WP_URL;

// 3. Query untuk mengambil data kategori & postingannya secara langsung
const query = {
  query: `
    query GetPostsByCat($catSlug: ID!) {
      category(id: $catSlug, idType: SLUG) {
        name
        description
        posts(first: 100) {
          nodes {
            title
            slug
            excerpt
            date
            author { node { name } }
            categories { nodes { name } }
            featuredImage { node { sourceUrl } }
          }
        }
      }
    }
  `,
  variables: { catSlug: category },
};

let categoryData = null;
let formattedPosts = [];

try {
  const response = await fetch(WP_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(query),
  });
  const result = await response.json();
  categoryData = result.data?.category;

  if (categoryData) {
    const wpPosts = categoryData.posts?.nodes || [];
    formattedPosts = wpPosts.map((post: any) => ({
      id: post.slug,
      slug: post.slug,
      body: post.excerpt || "",
      data: {
        title: post.title || "Judul Tidak Tersedia",
        description: post.excerpt || "",
        date: post.date,
        image: post.featuredImage?.node?.sourceUrl || "/images/placeholder.png",
        categories: post.categories?.nodes.map((c: any) => c.name) || [categoryData.name],
        authors: [post.author?.node?.name || "Admin"],
      },
    }));
  }
} catch (e) {
  console.error("Gagal mengambil data kategori:", e);
}

// 4. Jika kategori tidak ditemukan di WordPress, arahkan ke 404
if (!categoryData) {
  return Astro.redirect("/404");
}

const title = humanize(categoryData.name || "");
---

<Base title={`${title} - Amina`} description={categoryData.description}>
  <section class="bg-[#0b1c3c] py-16 md:py-20 text-white w-full border-t border-white/5">
    <div class="container text-center">
      <p class="text-white/50 text-[11px] font-bold uppercase tracking-[0.2em] mb-4">ARSIP KATEGORI</p>
      <h1 class="text-3xl md:text-5xl font-black text-primary uppercase italic">{title}</h1>
      {categoryData.description && (
        <p class="mt-4 text-white/60 max-w-2xl mx-auto text-sm md:text-base italic" set:html={categoryData.description} />
      )}
    </div>
  </section>

  <section class="section py-16 bg-white">
    <div class="container">
      {formattedPosts.length > 0 ? (
        <div class="grid grid-cols-1 gap-12">
          <Posts posts={formattedPosts} fluid={false} />
        </div>
      ) : (
        <div class="text-center py-24 border-2 border-dashed border-gray-100 rounded-3xl">
          <p class="text-dark/40 italic font-medium">Belum ada artikel dalam kategori ini.</p>
          <a href="/" class="mt-6 inline-block text-primary font-bold hover:underline">Kembali ke Beranda</a>
        </div>
      )}
    </div>
  </section>
</Base>