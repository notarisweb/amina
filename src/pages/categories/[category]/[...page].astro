---
import Posts from "@/components/Posts.astro";
import Base from "@/layouts/Base.astro";
import Pagination from "@/layouts/components/Pagination.astro";
import { humanize } from "@/lib/utils/textConverter";

export const prerender = false;

// 1. Ambil Parameter: category (slug) dan page (nomor halaman dari query)
const { category } = Astro.params;
const url = new URL(Astro.request.url);
const currentPage = parseInt(url.searchParams.get("page") || "1");
const pageSize = 10; // 10 card per halaman

const WP_URL = import.meta.env.PUBLIC_WP_URL;

// 2. Query WordPress: Mengambil data kategori dan daftar artikel
const query = {
  query: `
    query GetCategoryPosts($catSlug: ID!) {
      category(id: $catSlug, idType: SLUG) {
        name
        description
        posts(first: 100) {
          nodes {
            title
            slug
            excerpt
            date
            author { node { name } }
            categories { nodes { name } }
            featuredImage { node { sourceUrl } }
          }
        }
      }
    }
  `,
  variables: { catSlug: category },
};

let categoryData = null;
let allFormattedPosts = [];

try {
  const response = await fetch(WP_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(query),
  });
  const result = await response.json();
  categoryData = result.data?.category;

  if (categoryData) {
    const wpPosts = categoryData.posts?.nodes || [];
    allFormattedPosts = wpPosts.map((post: any) => ({
      id: post.slug,
      slug: post.slug,
      body: post.excerpt || "",
      data: {
        title: post.title || "Judul Tidak Tersedia",
        description: post.excerpt || "",
        date: post.date,
        image: post.featuredImage?.node?.sourceUrl || "/images/placeholder.png",
        categories: post.categories?.nodes.map((c: any) => c.name) || [categoryData.name],
        authors: [post.author?.node?.name || "Admin"],
      },
    }));
  }
} catch (e) {
  console.error("Gagal mengambil data kategori:", e);
}

if (!categoryData) return Astro.redirect("/404");

// 3. Logika Pagination Manual
const totalPosts = allFormattedPosts.length;
const totalPages = Math.ceil(totalPosts / pageSize);
const startIdx = (currentPage - 1) * pageSize;
const endIdx = startIdx + pageSize;
const paginatedPosts = allFormattedPosts.slice(startIdx, endIdx);

const title = humanize(categoryData.name || "");
---

<Base title={`${title} - Halaman ${currentPage}`} description={categoryData.description}>
  <section class="bg-[#0b1c3c] py-16 text-white w-full border-t border-white/5">
    <div class="container text-center">
      <p class="text-white/50 text-[11px] font-bold uppercase tracking-[0.2em] mb-4">ARSIP KATEGORI</p>
      <h1 class="text-3xl md:text-5xl font-black text-primary uppercase italic">{title}</h1>
      <p class="mt-4 text-white/60 text-sm italic">Halaman {currentPage} dari {totalPages}</p>
    </div>
  </section>

  <section class="section py-16 bg-white">
    <div class="container">
      {paginatedPosts.length > 0 ? (
        <>
          <Posts posts={paginatedPosts} fluid={false} />
          
          <div class="mt-16 flex justify-center">
            <Pagination 
              section={`categories/${category}`} 
              currentPage={currentPage} 
              totalPages={totalPages} 
            />
          </div>
        </>
      ) : (
        <div class="text-center py-24 border-2 border-dashed border-gray-100 rounded-3xl">
          <p class="text-dark/40 italic">Tidak ada artikel di halaman ini.</p>
          <a href={`/categories/${category}`} class="mt-4 inline-block text-primary font-bold">Kembali ke Halaman 1</a>
        </div>
      )}
    </div>
  </section>
</Base>