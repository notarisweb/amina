---
import Base from "@/layouts/Base.astro";
import PostSingle from "@/layouts/partials/PostSingle.astro";

export async function getStaticPaths() {
  // 1. Mengambil URL API dari Environment Variable Vercel
  const WP_URL = import.meta.env.PUBLIC_WP_URL;
  
  const query = {
    query: `
      query GetAllPosts {
        posts(first: 100) {
          nodes {
            title
            slug
            content
            date
            excerpt
            author {
              node {
                name
              }
            }
            categories {
              nodes {
                name
              }
            }
            featuredImage {
              node {
                sourceUrl
              }
            }
          }
        }
      }
    `,
  };

  try {
    const response = await fetch(WP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(query),
    });

    const result = await response.json();
    const posts = result.data?.posts?.nodes || [];

    // 2. Mapping data dengan pengaman nilai null/undefined
    return posts.map((post: any) => ({
      params: { single: post.slug },
      props: { 
        post: {
          id: post.slug,
          slug: post.slug,
          // Fallback string kosong untuk mencegah error marked()
          content: post.content || "", 
          data: {
            // Fallback judul agar atribut alt gambar tidak kosong
            title: post.title || "Judul Artikel", 
            description: post.excerpt || "",
            date: post.date,
            image: post.featuredImage?.node?.sourceUrl || "/images/placeholder.png",
            categories: post.categories?.nodes.map((c: any) => c.name) || ["Lainnya"],
            authors: [post.author?.node?.name || "Admin"],
          }
        } 
      },
    }));
  } catch (error) {
    console.error("Gagal mengambil data dari studio.amina.or.id:", error);
    return [];
  }
}

const { post } = Astro.props;
---

<Base 
  title={post.data.title} 
  description={post.data.description} 
  image={post.data.image}
>
  {/* Komponen PostSingle yang sudah diperbaiki rasio gambarnya */}
  <PostSingle post={post} />
</Base>