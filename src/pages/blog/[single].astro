---
import { Image } from "astro:assets";
import Base from "@/layouts/Base.astro";
import dateFormat from "@/lib/utils/dateFormat";
import { humanize, markdownify, slugify } from "@/lib/utils/textConverter";
import { BiCalendarEdit, BiUserCircle, BiChevronRight } from "react-icons/bi";

// 1. Matikan Prerender untuk memaksa SSR
export const prerender = false;

// 2. Ambil slug dari URL
const { single } = Astro.params;

const WP_URL = import.meta.env.PUBLIC_WP_URL;

// 3. Query untuk mengambil SATU postingan berdasarkan slug (lebih ringan & cepat)
const query = {
  query: `
    query GetPostBySlug($id: ID!) {
      post(id: $id, idType: SLUG) {
        title
        content
        date
        excerpt
        author { node { name } }
        categories { nodes { name } }
        featuredImage { node { sourceUrl } }
      }
      posts(first: 10) { 
        nodes {
          title
          slug
          categories { nodes { name } }
          featuredImage { node { sourceUrl } }
        }
      }
    }
  `,
  variables: { id: single },
};

let postData;
let allPosts = [];

try {
  const response = await fetch(WP_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(query),
  });

  const result = await response.json();
  postData = result.data?.post;
  allPosts = result.data?.posts?.nodes || [];
} catch (error) {
  console.error("Gagal fetch data WordPress:", error);
}

// 4. Jika postingan tidak ada di WordPress, langsung 404
if (!postData) {
  return Astro.redirect("/404");
}

// Format data untuk template
const post = {
  content: postData.content,
  data: {
    title: postData.title,
    description: postData.excerpt,
    date: postData.date,
    image: postData.featuredImage?.node?.sourceUrl || "/images/placeholder.png",
    categories: postData.categories?.nodes.map((c: any) => c.name) || ["Artikel Islami"],
    authors: [postData.author?.node?.name || "Admin"],
  }
};

const formattedAllPosts = allPosts.map((p: any) => ({
  slug: p.slug,
  data: {
    title: p.title,
    image: p.featuredImage?.node?.sourceUrl || "/images/placeholder.png",
    categories: p.categories?.nodes.map((c: any) => c.name) || [],
  }
}));

// Logika Sidebar & Related
const primaryCategory = post.data.categories[0] || "Berita";
const relatedPosts = formattedAllPosts
  .filter((p: any) => p.slug !== single && p.data.categories.includes(primaryCategory))
  .slice(0, 2);
const popularPosts = formattedAllPosts.slice(0, 5);
const uniqueCategories = [...new Set(formattedAllPosts.flatMap((p: any) => p.data.categories))];
---

<Base title={post.data.title} description={post.data.description} image={post.data.image}>
  <section class="bg-[#0b1c3c] py-8 md:py-10 text-white w-full border-t border-white/5">
    <div class="container">
       <nav class="flex items-center space-x-2 text-[10px] md:text-[11px] mb-5 text-white/40 font-bold uppercase tracking-widest">
        <a href="/" class="hover:text-primary transition">BERANDA</a>
        <BiChevronRight />
        <a href={`/categories/${slugify(primaryCategory)}`} class="hover:text-primary transition">{primaryCategory}</a>
        <BiChevronRight />
        <span class="text-white/90 italic normal-case font-medium">{post.data.title}</span>
      </nav>
      <h1 set:html={post.data.title} class="text-2xl md:text-4xl font-black leading-tight mb-6" />
      <div class="flex flex-wrap gap-5 text-[10px] md:text-[11px] font-bold text-white/60 uppercase tracking-widest border-t border-white/10 pt-6">
        <span class="flex items-center"><BiUserCircle className="mr-2 h-4 w-4 text-primary" /> {post.data.authors[0]}</span>
        <span class="flex items-center"><BiCalendarEdit className="mr-2 h-4 w-4 text-primary" /> {dateFormat(post.data.date)}</span>
      </div>
    </div>
  </section>

  <section class="py-12 bg-white">
    <div class="container">
      <div class="flex flex-wrap lg:flex-nowrap gap-12">
        <article class="w-full lg:w-[70%]">
          {post.data.image && (
            <div class="mb-10 overflow-hidden rounded-3xl shadow-xl aspect-video relative">
              <img src={post.data.image} class="absolute inset-0 w-full h-full object-cover" alt={post.data.title} />
            </div>
          )}
          <div class="content prose prose-lg max-w-none" set:html={post.content} />
        </article>
        
        <aside class="w-full lg:w-[30%]">
           <div class="sticky top-32 space-y-8">
              <h2 class="font-bold border-b-2 border-primary inline-block mb-4 text-dark">POSTINGAN TERBARU</h2>
              <ul class="space-y-4">
                {popularPosts.map((p) => (
                  <li class="flex gap-3">
                    <img src={p.data.image} class="w-16 h-12 object-cover rounded-lg" />
                    <a href={`/blog/${p.slug}`} class="text-sm font-bold hover:text-primary transition line-clamp-2 text-dark">{p.data.title}</a>
                  </li>
                ))}
              </ul>
           </div>
        </aside>
      </div>
    </div>
  </section>
</Base>