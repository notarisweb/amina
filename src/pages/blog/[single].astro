---
import Base from "@/layouts/Base.astro";
import PostSingle from "@/layouts/partials/PostSingle.astro";

export async function getStaticPaths() {
  // 1. Mengambil URL API dari Environment Variable Vercel
  const WP_URL = import.meta.env.PUBLIC_WP_URL;
  
  const query = {
    query: `
      query GetAllPosts {
        posts(first: 100) {
          nodes {
            title
            slug
            content
            date
            excerpt
            author {
              node {
                name
              }
            }
            categories {
              nodes {
                name
              }
            }
            featuredImage {
              node {
                sourceUrl
              }
            }
          }
        }
      }
    `,
  };

  try {
    const response = await fetch(WP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(query),
    });

    const result = await response.json();
    const posts = result.data?.posts?.nodes || [];

    // 2. Format daftar seluruh artikel untuk fitur 'Artikel Terkait'
    const allPostsFormatted = posts.map((p: any) => ({
      slug: p.slug,
      data: {
        title: p.title || "Judul Artikel",
        image: p.featuredImage?.node?.sourceUrl || "/images/placeholder.png",
        categories: p.categories?.nodes.map((c: any) => c.name) || [],
        date: p.date
      }
    }));

    // 3. Mapping data untuk setiap halaman artikel tunggal
    return posts.map((post: any) => ({
      params: { single: post.slug },
      props: { 
        post: {
          id: post.slug,
          slug: post.slug,
          content: post.content || "", // Fallback agar tidak error marked()
          data: {
            title: post.title || "Judul Artikel", 
            description: post.excerpt || "",
            date: post.date,
            image: post.featuredImage?.node?.sourceUrl || "/images/placeholder.png",
            categories: post.categories?.nodes.map((c: any) => c.name) || ["Islam"],
            authors: [post.author?.node?.name || "Admin"],
          }
        },
        // MENGIRIM DATA POSTS KE PROPS (Solusi error filter)
        posts: allPostsFormatted 
      },
    }));
  } catch (error) {
    console.error("Gagal mengambil data dari studio.amina.or.id:", error);
    return [];
  }
}

const { post, posts } = Astro.props;
---

<Base 
  title={post.data.title} 
  description={post.data.description} 
  image={post.data.image}
>
  {/* Mengirim post (tunggal) dan posts (daftar semua) ke komponen */}
  <PostSingle post={post} posts={posts} />
</Base>