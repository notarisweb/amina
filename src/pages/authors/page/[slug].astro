---
import Authors from "@/components/Authors.astro";
import config from "@/config/config.json";
import Base from "@/layouts/Base.astro";
import Pagination from "@/layouts/components/Pagination.astro";

export async function getStaticPaths() {
  // 1. Menggunakan Environment Variable untuk fleksibilitas API
  const WP_URL = import.meta.env.PUBLIC_WP_URL;
  
  // 2. Query untuk mengambil semua penulis dari WordPress
  const query = {
    query: `query { users { nodes { name slug description avatar { url } } } }`,
  };

  const response = await fetch(WP_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(query),
  });
  
  const result = await response.json();
  const authors = result.data?.users?.nodes || [];
  
  const totalPages = Math.ceil(authors.length / config.settings.pagination);
  const paths = [];

  // Menghasilkan path untuk halaman 2 dan seterusnya
  for (let i = 1; i < totalPages; i++) {
    paths.push({
      params: {
        slug: (i + 1).toString(),
      },
    });
  }
  return paths;
}

const { slug } = Astro.params;
const WP_URL = import.meta.env.PUBLIC_WP_URL;

// 3. Ambil data penulis kembali untuk perankingan/pembagian halaman
const query = {
  query: `query { users { nodes { name slug description avatar { url } } } }`,
};

const response = await fetch(WP_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(query),
});

const result = await response.json();
const wpAuthors = result.data?.users?.nodes || [];

// 4. Mapping data dengan pengaman (fallback) untuk mencegah error build
const allAuthors = wpAuthors.map((user: any) => ({
  id: user.slug,
  slug: user.slug,
  body: user.description || "", // Mencegah error marked() jika deskripsi kosong
  data: {
    title: user.name || "Penulis",
    image: user.avatar?.url || "/images/author-placeholder.png",
    description: user.description || "",
    social: [],
  }
}));

const totalPages = Math.ceil(allAuthors.length / config.settings.pagination);
const currentPage = slug && !isNaN(Number(slug)) ? Number(slug) : 1;
const indexOfLastPost = currentPage * config.settings.pagination;
const indexOfFirstPost = indexOfLastPost - config.settings.pagination;
const currentAuthors = allAuthors.slice(indexOfFirstPost, indexOfLastPost);
---

<Base title={`Penulis - Halaman ${currentPage}`}>
  <section class="section">
    <div class="container text-center">
      <h1 class="page-heading h2 mb-16">Para Penulis</h1>
      
      {currentAuthors.length > 0 ? (
        <>
          <Authors authors={currentAuthors} />
          <div class="mt-16 flex justify-center">
            <Pagination
              section={"authors"}
              currentPage={currentPage}
              totalPages={totalPages}
            />
          </div>
        </>
      ) : (
        <p class="py-20">Data penulis tidak ditemukan.</p>
      )}
    </div>
  </section>
</Base>