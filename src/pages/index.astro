---
import Posts from "@/components/Posts.astro";
import config from "@/config/config.json";
import Base from "@/layouts/Base.astro";
import Pagination from "@/layouts/components/Pagination.astro";

// 1. Menggunakan Environment Variable dari dashboard Vercel
const WP_URL = import.meta.env.PUBLIC_WP_URL;

// 2. Query diperbarui untuk mengambil data penulis, kategori, dan gambar utama
const query = {
  query: `
    query GetPosts {
      posts(first: 10) {
        nodes {
          title
          slug
          excerpt
          date
          author {
            node {
              name
            }
          }
          categories { 
            nodes { 
              name 
            } 
          }
          featuredImage { 
            node { 
              sourceUrl 
            } 
          }
        }
      }
    }
  `,
};

let currentPosts = [];
let totalPages = 1;

try {
  const response = await fetch(WP_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(query),
  });
  
  const result = await response.json();
  const wpPosts = result.data?.posts?.nodes || [];

  // 3. Pemetaan Data diperketat dengan fallback string kosong || "" untuk keamanan
  currentPosts = wpPosts.map((post: any) => ({
    id: post.slug, 
    slug: post.slug,
    body: post.excerpt || "", // Mencegah error marked() jika kutipan kosong
    data: {
      title: post.title || "Judul Tidak Tersedia", // Mencegah error ImageMissingAlt
      description: post.excerpt || "", 
      date: post.date,
      image: post.featuredImage?.node?.sourceUrl || "/images/placeholder.png",
      categories: post.categories?.nodes.map((c: any) => c.name) || ["Islam"],
      authors: [post.author?.node?.name || "Admin"], // Fallback nama penulis agar tidak undefined
    }
  }));

  totalPages = Math.ceil(currentPosts.length / config.settings.pagination);
} catch (e) {
  console.error("Gagal mengambil data dari WordPress studio.amina.or.id:", e);
}
---

<Base>
  <section class="section">
    <div class="container">
      {currentPosts.length > 0 ? (
        <>
          {/* Komponen Posts dengan data yang sudah di-mapping aman */}
          <Posts posts={currentPosts} className="mb-16" />
          
          {/* Navigasi Pagination angka jika artikel lebih dari batas halaman */}
          {totalPages > 1 && (
            <div class="mt-16 flex justify-center">
              <Pagination currentPage={1} totalPages={totalPages} />
            </div>
          )}
        </>
      ) : (
        <div class="text-center py-20">
          <p class="text-xl">Tidak ada artikel ditemukan.</p>
          <p class="text-sm text-gray-500 mt-2">
            Pastikan WordPress di studio.amina.or.id dapat diakses.
          </p>
        </div>
      )}
    </div>
  </section>
</Base>