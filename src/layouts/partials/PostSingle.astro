---
import { Image } from "astro:assets";
import dateFormat from "@/lib/utils/dateFormat";
import { humanize, markdownify, slugify } from "@/lib/utils/textConverter";
import { BiCalendarEdit, BiCategoryAlt, BiUserCircle } from "react-icons/bi";
import SimilarPosts from "@/components/SimilarPosts.astro";

const { post, posts } = Astro.props;

// 1. Logika Mendapatkan 10 Postingan Terpopuler (Berdasarkan Tanggal Terbaru 1 Bulan Terakhir)
const oneMonthAgo = new Date();
oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);

const popularPosts = posts
  .filter((p: any) => new Date(p.data.date) >= oneMonthAgo)
  .slice(0, 10);

// 2. Logika Mendapatkan Daftar Kategori Unik untuk Sidebar
const allCategories = posts.flatMap((p: any) => p.data.categories);
const uniqueCategories = [...new Set(allCategories)];
---

<section class="section pt-7">
  <div class="container">
    <div class="row gx-5">
      <article class="col-12 lg:col-8">
        {post.data.image && (
          <div class="mb-10 overflow-hidden rounded-lg aspect-video w-full relative">
            <Image
              src={post.data.image}
              class="absolute inset-0 w-full h-full object-cover"
              alt={post.data.title}
              width={900}
              height={500}
            />
          </div>
        )}
        
        <h1 set:html={markdownify(post.data.title)} class="h2 mb-4" />
        
        <ul class="mb-8 flex flex-wrap items-center text-text italic">
          <li class="mr-5 flex items-center">
            <BiUserCircle className="mr-1 h-5 w-5 text-primary" />
            {post.data.authors?.[0] || "Admin"}
          </li>
          <li class="mr-5 flex items-center">
            <BiCalendarEdit className="mr-1 h-5 w-5 text-primary" />
            {dateFormat(post.data.date)}
          </li>
          <li class="mr-5 flex items-center">
            <BiCategoryAlt className="mr-1 h-5 w-5 text-primary" />
            <ul class="flex gap-1">
              {post.data.categories.map((category: string, i: number) => (
                <li>
                  <a href={`/categories/${slugify(category)}`} class="hover:text-primary transition">
                    {humanize(category)}{i < post.data.categories.length - 1 && ","}
                  </a>
                </li>
              ))}
            </ul>
          </li>
        </ul>

        <div class="content mb-16 text-left prose prose-img:rounded-lg" set:html={post.content} />
      </article>

      <aside class="col-12 lg:col-4 mt-10 lg:mt-0">
        <div class="sticky top-24">
          <div class="bg-theme-light p-6 rounded-lg mb-8 shadow-sm border-t-4 border-primary">
            <h2 class="h5 mb-6 pb-2 border-b">Postingan Populer</h2>
            <ul class="space-y-5">
              {popularPosts.map((p: any) => (
                <li class="flex gap-4 items-start group border-b border-gray-100 pb-4 last:border-0">
                  <div class="w-20 h-16 shrink-0 overflow-hidden rounded">
                    <img 
                      src={p.data.image} 
                      class="w-full h-full object-cover group-hover:scale-110 transition duration-300" 
                      alt={p.data.title}
                    />
                  </div>
                  <div>
                    <h3 class="text-sm font-bold leading-tight mb-1">
                      <a href={`/blog/${p.slug}`} class="hover:text-primary transition line-clamp-2">
                        {p.data.title}
                      </a>
                    </h3>
                    <span class="text-xs text-text opacity-70">{dateFormat(p.data.date)}</span>
                  </div>
                </li>
              ))}
            </ul>
          </div>

          <div class="bg-theme-light p-6 rounded-lg shadow-sm border-t-4 border-secondary">
            <h2 class="h5 mb-6 pb-2 border-b">Kategori</h2>
            <ul class="space-y-3 font-medium">
              {uniqueCategories.map((category: string) => (
                <li>
                  <a 
                    href={`/categories/${slugify(category)}`} 
                    class="flex items-center justify-between p-2 rounded hover:bg-white hover:text-primary transition shadow-sm bg-gray-50/50"
                  >
                    <span>{humanize(category)}</span>
                    <span class="text-xs bg-gray-200 px-2 py-1 rounded-full">
                      {posts.filter((p: any) => p.data.categories.includes(category)).length}
                    </span>
                  </a>
                </li>
              ))}
            </ul>
          </div>
        </div>
      </aside>
    </div>

    <div class="mt-20">
      <h2 class="h3 mb-8 text-center">Artikel Terkait</h2>
      <SimilarPosts posts={posts.filter((p: any) => p.slug !== post.slug)} currentPost={post} />
    </div>
  </div>
</section>