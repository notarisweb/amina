---
import Share from "@/components/Share.astro";
import SimilarPosts from "@/components/SimilarPosts.astro";
import dateFormat from "@/lib/utils/dateFormat";
import similerItems from "@/lib/utils/similarItems";
import { humanize, markdownify, slugify } from "@/lib/utils/textConverter";
import { Image } from "astro:assets";
import { BiCalendarEdit, BiCategoryAlt, BiUserCircle } from "react-icons/bi";

// Menerima props post dan daftar posts untuk artikel terkait
const { post, posts } = Astro.props;

// Mencari artikel terkait berdasarkan kategori/tag yang sama
const similarPosts = similerItems(post, posts, post.slug);

// Destructuring data dengan fallback untuk keamanan build
const { 
  title = "Judul Artikel", 
  description = "", 
  authors = ["Admin"], 
  categories = [], 
  image, 
  date, 
  tags = [] 
} = post.data;
---

<section class="section">
  <div class="container">
    <article class="row justify-center">
      <div class="md:col-10 text-center">
        <h1 set:html={markdownify(title || "")} class="h2 mb-6" />
        
        <ul class="mt-4 flex flex-wrap items-center justify-center text-text text-sm border-b pb-6">
          <li class="mx-3 flex items-center font-bold text-dark">
            <BiUserCircle className="mr-1 h-5 w-5 text-primary" />
            <a href={`/authors/${slugify(authors[0])}`} class="hover:text-primary transition">
              {authors[0]}
            </a>
          </li>
          <li class="mx-3 flex items-center font-medium">
            <BiCalendarEdit className="mr-1 h-5 w-5 text-gray-600" />
            {date ? dateFormat(date) : "N/A"}
          </li>
          <li class="mx-3 flex items-center flex-wrap">
            <BiCategoryAlt className="mr-1 h-[18px] w-[18px] text-gray-600" />
            <ul class="flex">
              {(categories || []).map((category: string, i: number) => (
                <li class="inline-block">
                  <a href={`/categories/${slugify(category)}`} class="mr-2 hover:text-primary font-bold">
                    {humanize(category)}{i !== (categories.length - 1) && ","}
                  </a>
                </li>
              ))}
            </ul>
          </li>
        </ul>
      </div>

      <div class="col-12 mt-8 mb-10">
        {image && (
          <div class="main-article-image shadow-lg">
            <Image
              src={image}
              height={500}
              width={1000}
              alt={title || "Gambar Utama Artikel"} 
              class="rounded-xl w-full object-cover"
              loading="eager"
            />
          </div>
        )}
      </div>

      <div class="md:col-10">
        <div 
          class="content mb-16 text-left post-content-style" 
          set:html={post.content || "Konten tidak tersedia."} 
        />
        
        <div class="flex flex-wrap items-center justify-between border-t border-border pt-8">
          <ul class="mr-4 mb-4 space-x-3">
            {(tags || []).map((tag: string) => (
              <li class="inline-block">
                <a href={`/tags/${slugify(tag)}`} class="block rounded-lg bg-light px-4 py-2 font-semibold text-dark text-xs hover:text-primary transition duration-300">
                  #{humanize(tag)}
                </a>
              </li>
            ))}
          </ul>
          <Share 
            className="social-share mb-4" 
            title={title} 
            description={description} 
            slug={post.slug} 
          />
        </div>
      </div>
    </article>
  </div>
</section>

{similarPosts && similarPosts.length > 0 && (
  <section class="section pt-0">
    <div class="container">
      <hr class="mb-16 border-border" />
      <h2 class="mb-8 text-center h3">Artikel Terkait</h2>
      <SimilarPosts posts={similarPosts.slice(0, 3)} />
    </div>
  </section>
)}

<style>
  /* Penyesuaian Rasio Gambar agar Persegi Panjang (Cinematic) */
  .main-article-image { 
    width: 100%; 
    aspect-ratio: 21 / 9 !important; 
    max-height: 500px; 
    overflow: hidden; 
    border-radius: 12px; 
  }
  .main-article-image img { 
    width: 100% !important; 
    height: 100% !important; 
    object-fit: cover !important; 
  }
  
  /* Styling Konten Artikel dari WordPress */
  .post-content-style :global(p) { margin-bottom: 1.5rem; line-height: 1.8; color: #333; font-size: 1.125rem; }
  .post-content-style :global(h2), .post-content-style :global(h3) { margin-top: 2rem; margin-bottom: 1rem; font-weight: 700; }
  .post-content-style :global(img) { border-radius: 8px; margin: 2rem 0; }
  
  @media (max-width: 768px) { 
    .main-article-image { aspect-ratio: 16 / 9 !important; height: auto; } 
  }
</style>